# 8008 instruction executor for x86

x86系CPUで8008機械語を解釈して実行するモジュールです。  

本モジュールは 8008CPU用 実数型BASIC SCELBAL BASICを  
MS-DOS上で実行する 8008 loader for generic MS-DOS の  
8008コードエミュレーションモジュールとして開発しました。  

出来上がった 8008EM.BINはOSに依存しないため  
MS-DOS CP/M-86 DR-DOS ベアメタル いずれでも使えます。  

## ビルド環境

OS：MS-DOS  
アセンブラ：Microsoft Macro assembler 6.00AD  

上記MASM6.0のほかに生成した 8008EM.EXEの  
EXEヘッダの切り離しにSYMDEBを使っています。  

ファイル構成  
8008EM.ASM --- ソースファイル  
08.BAT ------- アセンブル、EXEヘッダ切り離しを一連で実行するバッチ  
8008EM.PAT --- EXEヘッダ切り離しをSYMDEBで実行するためのスクリプト  
8008EM.LST --- MASMが生成するリスティングファイル  
8008EM.OBJ --- MASMが生成するオブジェクトファイル  
8008EM.EXE --- MASMが生成する実行ファイル（単体での実行は無意味）  
8008EM.BIN --- 8080EM.EXEからEXEヘッダを切り離しOS非依存にしたモジュール  

## 使い方

x86 16bit環境で本モジュールを任意のRAM領域にロード、  
セグメントレジスタ DS には 8008コードをロードしたセグメント値を設定し  
エントリポイント(nnnn:0e0h)を FAR CALL します。  

DIに0以外を設定した場合は、命令実行数カウンタにその値をロードし  
命令実行ごとにカウンタを1減算し、0になるとブレークします。  
DIに0を設定した場合は連続実行します。  

本モジュールと8080コードのロードに各64KB  
合計128KBの空きエリアが必要です。  

8008のレジスタは、以下の通りx86レジスタに対応させています、  
8008コード実行（FAR CALL）に先立ち、各レジスタを設定しておきます。  

8008 -- x86  
Flag -- AH  
A ----- AL  
B ----- CH  
C ----- CL  
D ----- DH  
E ----- DL  
H ----- BH  
L ----- BL  
PC ---- SI  
SP ---- BP  

リターン条件  

IN、OUT、HLT、未定義命令をフェッチするとその命令は実行せず  
その命令コードのアドレスををSIに、リターンコードをDIに  
8008レジスタ値を対応するレジスタに保持して戻ります。  

命令実行数カウンタが0になった場合は  
次に実行される命令のアドレスをSIに、リターンコード 0fbhをDIに保持し、  
8008レジスタ値を対応するレジスタに保持して戻ります。  

リターンコード  
 0ffh:  HLT命令（命令コード 0FFH）  
 0feh:  HLT命令（命令コード 01H）  
 0fdh:  HLT命令（命令コード 00H）  
 0fch:  未定義命令  
 0fbh:  命令数カウンタ0ブレーク  
 0-7:   IN命令 （数値はポート番号）  
 8-1fh: OUT命令（数値はポート番号）  

## 8008のスタックポインタの扱い

8008は 8レベルのコールスタックを持っていますが、  
プログラムからはその値を設定することも参照することもできません。  
SPはCALL,RST,RET命令によってのみ制御され、上限8レベルを超えると  
ラップラウンドします。  

8008実機のスタック[0-7]がCALLによって増加するのが減少するのかは  
データシートからは読解できませんでしたが、本エミュレータでは  
8008メモリ空間（0000-3ffffh）の直上 4004h～アドレス増加方向に  
向かってスタックを確保しています。  

## ライセンス

MITライセンスとします。

## 8008 CPU について

GNDが無い、リセット端子が無い、等、18ピンに収めるため  
工夫（苦労）しているようです。  

また、ニモニックは旧新あり、新ニモニックは8080（下位）互換です。  
バイナリは互換性ありませんが、CPU指定を変更すれば  
8008アセンブラソースを変更なしで8080に流用できます。  

データシートは以下リンクを参照ください。  
http://www.bitsavers.org/components/intel/MCS8/Intel_8008_8-Bit_Parallel_Central_Processing_Unit_Rev1_Apr72.pdf

## 8008 CPU 搭載ミニコン SCELBIについて

詳細な資料が集約されています。  
https://www.scelbi.com/

実数型 SCELBAL BASIC はソース含め公開されています。  
https://www.willegal.net/scelbi/the8008andScelbi.html

## 変更履歴
2025/6/1 Rev. 1.00 初回公開
2025/6/7 Rev. 1.01 ブレークカウンタ処理を改善し高速化しました
